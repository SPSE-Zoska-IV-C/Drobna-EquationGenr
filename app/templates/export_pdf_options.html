{% extends "_base.html" %}
{% block title %}Export to PDF{% endblock %}

{% block content %}
<div class="export-container">
  <h2>Export to PDF</h2>

  <form id="export-form">
    <label>What do you want to export?</label>
    <select id="export-type" required>
      <option value="equations">Equations</option>
      <option value="functions">Functions</option>
    </select>

    <label>Template</label>
    <select id="template" required>
      <option value="template_1">Template 1 (1 column)</option>
      <option value="template_2">Template 2 (2 columns)</option>
    </select>

    <label>Number of items</label>
    <input type="number" id="limit" min="1" max="20" value="10" required>
    <div id="limit-flash" class="flash hidden"></div>
    
    <label>Source</label>
    <select id="source" required>
      <option value="existing">Pick from existing ones</option>
      <option value="generate">Generate new</option>
    </select>
  </form>

  <button type="button" id="content-btn">Content of PDF</button>

  <!-- DYNAMIC CONTAINER -->
  <div id="pdf-source-container" class="hidden">

    <!-- GENERATE MODE -->
    <div id="generate-preview" class="hidden">
      <h3>Generate new content</h3>

      <div id="gen-equations" class="hidden">
        <label>Type</label>
        <select id="gen-eq-type">
          <option value="logarithmic - solved by substitution">logarithmic - solved by substitution</option>
          <option value="logarithmic - solved by logarithm rules">logarithmic - solved by logarithm rules</option>
          <option value="logarithmic - random methods of solving">logarithmic - random methods of solving</option>
          <option value="exponential - solved by substitution">exponential - solved by substitution</option>
          <option value="exponential - solved by converting it to same base">exponential - solved by converting it to same base</option>
          <option value="exponential - solved by logarithms">exponential - solved by logarithms</option>
          <option value="exponential - random methods of solving">exponential - random methods of solving</option>
          <option value="random equations">random equations</option>
        </select>

        <label>Level</label>
        <select id="gen-eq-level">
          <option value="simple">simple</option>
          <option value="advanced">advanced</option>
        </select>
      </div>

      <div id="gen-functions" class="hidden">
        <label>Type</label>
        <select id="gen-fn-type">
          <option value="logarithmic functions">logarithmic functions</option>
          <option value="exponential functions">exponential functions</option>
          <option value="random functions">random mix of functions</option>
        </select>
      </div>

      <label>Number</label>
      <input type="number" id="gen-number" readonly>
    </div>

    <!-- EXISTING MODE -->
    <div id="existing-picker" class="hidden">
      <h3>Select items for PDF</h3>
      <p>Select exactly <strong id="required-count"></strong> items</p>
      <div id="items-list" class="items-grid"></div>
    </div>

    <button id="generate-pdf-btn" disabled>Generate PDF</button>
  </div>
</div>

<!-- MathJax for elegant formula rendering -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("content-btn");
  const container = document.getElementById("pdf-source-container");
  const exportType = document.getElementById("export-type");
  const sourceSelect = document.getElementById("source");
  const limitInput = document.getElementById("limit");

  const generatePreview = document.getElementById("generate-preview");
  const existingPicker = document.getElementById("existing-picker");
  const itemsList = document.getElementById("items-list");
  const requiredCount = document.getElementById("required-count");
  const genNumber = document.getElementById("gen-number");
  const generatePdfBtn = document.getElementById("generate-pdf-btn");

  const limitFlash = document.getElementById("limit-flash");

  function showFlash(message, type="danger") {
    limitFlash.textContent = message;
    limitFlash.classList.remove("hidden", "flash-danger", "flash-success");
    limitFlash.classList.add(type === "success" ? "flash-success" : "flash-danger");
  }

  function hideFlash() {
    limitFlash.textContent = "";
    limitFlash.classList.add("hidden");
    limitFlash.classList.remove("flash-danger", "flash-success");
  }

  function validateLimit() {
    const raw = limitInput.value;

    // empty
    if (raw === "" || raw === null || raw === undefined) {
      showFlash("Please enter a number between 1 and 20.");
      generatePdfBtn.disabled = true;
      return false;
    }

    // if user types something like "abc"
    const num = Number(raw);
    if (Number.isNaN(num)) {
      showFlash("Invalid input. Please enter a valid number.");
      generatePdfBtn.disabled = true;
      return false;
    }

    // float check
    if (!Number.isInteger(num)) {
      showFlash("Please enter a whole number (no decimals).");
      generatePdfBtn.disabled = true;
      return false;
    }

    // range check
    if (num < 1 || num > 20) {
      showFlash("Number must be between 1 and 20.");
      generatePdfBtn.disabled = true;
      return false;
    }

    // valid
    hideFlash();
    return true;
  }


  let selectedItems = [];

  btn.addEventListener("click", async () => {
    if (!validateLimit()) {
      container.classList.add("hidden");
      return;
    }

    container.classList.remove("hidden");
    selectedItems = [];
    generatePdfBtn.disabled = true;

    if (sourceSelect.value === "generate") {
      showGenerateMode();
    } else {
      await loadExistingItems();
    }
  });


  function showGenerateMode() {
    generatePreview.classList.remove("hidden");
    existingPicker.classList.add("hidden");

    document.getElementById("gen-equations").classList.add("hidden");
    document.getElementById("gen-functions").classList.add("hidden");

    if (exportType.value === "equations") {
      document.getElementById("gen-equations").classList.remove("hidden");
    } else {
      document.getElementById("gen-functions").classList.remove("hidden");
    }

    genNumber.value = limitInput.value;
    generatePdfBtn.disabled = false;
  }

  limitInput.addEventListener("input", () => {
    const valid = validateLimit();

    if (!valid) return;

    genNumber.value = limitInput.value;
    requiredCount.textContent = limitInput.value;

    // if existing mode -> reset selection because required count changed
    if (!existingPicker.classList.contains("hidden")) {
      selectedItems = [];
      document.querySelectorAll(".select-item.selected").forEach(el => el.classList.remove("selected"));
      generatePdfBtn.disabled = true;
    } else {
      // generate mode -> allow PDF generation
      generatePdfBtn.disabled = false;
    }
  });



  async function loadExistingItems() {
    generatePreview.classList.add("hidden");
    existingPicker.classList.remove("hidden");

    itemsList.innerHTML = "";
    selectedItems = [];
    requiredCount.textContent = limitInput.value;

    // Fetch LaTeX formulas directly
    const res = await fetch(`/api/${exportType.value}`);
    const data = await res.json();

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "select-item";
      div.dataset.id = item.id;

      // Render formula elegantly using LaTeX
      const p = document.createElement("p");
      p.className = "math-formula";
      p.innerHTML = `$$ ${item.label} $$`;
      div.appendChild(p);

      div.addEventListener("click", () => toggleItem(div));
      itemsList.appendChild(div);
    });

    // Trigger MathJax typesetting
    MathJax.typesetPromise();
  }

  function toggleItem(el) {
    const id = el.dataset.id;

    if (selectedItems.includes(id)) {
      selectedItems = selectedItems.filter(x => x !== id);
      el.classList.remove("selected");
    } else {
      if (selectedItems.length >= Number(limitInput.value)) return;
      selectedItems.push(id);
      el.classList.add("selected");
    }

    generatePdfBtn.disabled = selectedItems.length !== Number(limitInput.value);
  }

  generatePdfBtn.addEventListener("click", () => {
    const params = new URLSearchParams({
      export_type: exportType.value,
      template: document.getElementById("template").value,
      limit: limitInput.value,
      source: sourceSelect.value
    });

    if (sourceSelect.value === "existing") {
      params.append("ids", selectedItems.join(","));
    } else {
      if (exportType.value === "equations") {
        params.append("gen_type", document.getElementById("gen-eq-type").value);
        params.append("gen_level", document.getElementById("gen-eq-level").value);
      } else {
        params.append("gen_type", document.getElementById("gen-fn-type").value);
      }
    }

    window.location.href = `/export/pdf/generate?${params.toString()}`;
  });
});
</script>

<style>
.hidden { display: none; }

.select-item {
  padding: 10px;
  border: 2px solid #ccc;
  border-radius: 6px;
  cursor: pointer;
  background: #f8f8f8;
  text-align: center;

  /* New additions for stable sizing */
  width: 100%;         /* take full grid cell width */
  min-height: 60px;    /* stable minimum height */
  max-height: 150px;   /* maximum height before scrolling */
  overflow: auto;      /* scroll if formula is too long */
  display: flex;
  align-items: center;
  justify-content: center;
}

.math-formula {
  font-size: 1.1em;
  line-height: 1.4em;
  word-wrap: break-word;   /* break long formulas nicely */
  max-width: 100%;         /* ensure it doesnâ€™t exceed box */
}


.items-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.select-item {
  padding: 10px;
  border: 2px solid #ccc;
  border-radius: 6px;
  cursor: pointer;
  background: #f8f8f8;
  text-align: center;
}

.select-item.selected {
  background-color: #d6b065;
  color: #E9EDDE;
  border-color: #d6b065;
}

.math-formula {
  font-size: 1.1em;
  line-height: 1.4em;
}
</style>
{% endblock %}
